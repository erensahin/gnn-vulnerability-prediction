"""
Extract file changes module
"""

import os
import pandas as pd
import git
from vulnerability_prediction import REPOS


def get_file_changes(repo: git.Repo):
    """
    Returns all commit-file pairs of a repo
    :param repo: git.Repo
        Repository object
    :returns pd.DataFrame
        DataFrame of (commit_id, commit_date, file) tuples
    """
    commits = [
        {
            "commit_id": c.hexsha,
            "commit_date": c.committed_datetime,
            "file": list(c.stats.files.keys())
        }
        for c in repo.iter_commits()
    ]

    commits_df = pd.DataFrame(commits)

    return commits_df.explode('file')


def run():
    """ Main loop for extracting file changes """
    for repo_entry in REPOS.items():
        repo_key, repo_def = repo_entry
        repo = git.Repo(repo_def["path"])

        print("Searching for {}...".format(repo_key))

        file_path = os.path.join(repo_def["output_dir"],
                                 "{}_file_changes.csv".format(repo_key))

        file_changes_df = get_file_changes(repo)
        file_changes_df.to_csv(file_path, index=False)


if __name__ == "__main__":
    run()
